<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  
  <title>Gilt ReGrouper</title>
  
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0/jquery.mobile.structure-1.0.min.css" /> 
  <link rel="stylesheet" href="assets/stylesheets/gilt_regrouper.min.css" />
  <link rel="stylesheet" href="assets/stylesheets/main.css" />
  
  <script type="text/javascript" src="assets/javascripts/jquery-1.6.4.min.js"></script>
  <script type="text/javascript" src="assets/javascripts/jquery.mobile-1.0.min.js"></script>
  
  <script>
	
	$('#categories').live('pagecreate', function(event)
   	{
  		loadCategories();
    });
	
    $('#products').live('pagecreate', function(event) {
    	$("#venueSearchForm").submit(function(event){
			event.preventDefault();
			
			$("#searchTerm").val($("#venueSearchField").val());
			
			callVenueSearch();
			
			return false;
		});
    });
    
    
    function loadCategories()
    {
    	$.mobile.loadingMessage = "Loading categories for today's sales.";
		$.mobile.showPageLoadingMsg();
    	
    	$.ajax({
         url: "/api/categories",
         //data: {cagegory: category},
         dataType: 'json',
         beforeSend: function()
         {
			
         },
         complete: function()
         {
        	 $.mobile.hidePageLoadingMsg();
         },
         success: function(data) 
         {
        	$("#categories_list").empty();
        	
			if(data.status === 200 && data.data !== null && data.data.length > 0)
			{
				$.each(data.data, function(i, categoryCount) 
				{
					$(createCategoryListItem(categoryCount)).appendTo("#categories_list");
				});
        	}
        	else
         	{
        		var list_data = '<li><h3>No categories found.</h3></li>';
        		$(list_data).appendTo("#categories_list");
         	}
			
			$.mobile.changePage('#results', {
				transition: 'slide'
			});
			
			$('#categories_list').listview('refresh');
         }
        });
    }
	
    
    
    function callProductSearch(category)
    {
    	//alert("searching for "+category);
    	$.ajax({
         url: "/api/products",
         data: {category: category},
         dataType: 'json',
         beforeSend: function()
         {
			$.mobile.loadingMessage = "Loading products for "+category;
			$.mobile.showPageLoadingMsg();
         },
         complete: function()
         {
        	 $.mobile.hidePageLoadingMsg();
         },
         success: function(data) 
         {
        	$("#products_list").empty();
        	
			if(data.status === 200 && data.data !== null && data.data.length > 0)
			{
				$.each(data.data, function(i, product) 
				{
					$(createProductListItem(product)).appendTo("#products_list");
				});
        	}
        	else
         	{
        		var list_data = '<li><h3>No products found.</h3></li>';
        		$(list_data).appendTo("#products_list");
         	}
			
			$.mobile.changePage('#products', {
				transition: 'slide'
			});
			
			$('#products_list').listview('refresh');
         }
        });
    }
	
    function createCategoryListItem(categoryCount)
    {
    	var li = create('li');
    	
    	/*
    	li.append(create('span')
    			.addClass('ul-li-count')
    			.append(createText(categoryCount.count)));
    	*/
    	
    	var anchor = create('a');
    	anchor.append(create('h4')
    			.append(createText(categoryCount.name)));
    	
    	
    	anchor.append(create('img')    			
        		.attr('src',categoryCount.img)
				.addClass('ui-li-thumb')
				.addClass('categoryIcon')
        	);
    	
    	anchor.append(create('h3')
    			.append(createText(categoryCount.count+" starting at $"+categoryCount.minPrice)));
    	
    	anchor.click(function(event){
    		event.preventDefault();
			
    		callProductSearch(categoryCount.name);
    		
    		return false;
    	});
    	
    	li.append(anchor);
    	
    	return li;
    }
    
    function createProductListItem(product)
    {
    	var li = create('li');
    	var anchor = create('a');
    	anchor.attr('href',product.url);
    	
    	anchor.append(create('img')    			
        		.attr('src',product.imageUrls[0])
				.addClass('ui-li-thumb')
				.addClass('categoryIcon')
        	);
    	
    	var gridLayout = create('div');
    	gridLayout.addClass('ui-grid-a');
    	
    	var leftCol = create('div');
    	leftCol.addClass('ui-block-a');
    	leftCol.append(create('h3').addClass('productBrand').append(createText(product.brand)))
    	leftCol.append(create('h4').addClass('productName').append(createText(product.name)));
    	
    	
    	var rightCol = create('div');
    	rightCol.addClass('ui-block-b');
    	rightCol.append(create('h3').addClass('priceRange').append(createText(findPriceRange(product))));
    	
    	gridLayout.append(leftCol);
    	gridLayout.append(rightCol);
    	
    	anchor.append(gridLayout);

    	li.append(anchor);
    	
    	return li;
    }

    function findPriceRange(product)
    {
    	var min = null;
    	var max = null;
    	
    	$.each(product.skus, function(i, sku) 
		{
			var salePrice = parseFloat(sku.salePrice);
			//alert(sku+" - "+sku.salePrice)
    		if(min == null && salePrice != null)
    		{
    			min = salePrice;
    			max = salePrice;
    		}
    		
    		if(salePrice < min)
    		{
    			min = salePrice;
    		}
    		if(salePrice > max)
    		{
    			max = salePrice;
    		}
		});
    	
    	if( min != max){
    		return "$"+min+" - $"+max;	
    	}
    	else
    	{
    		return "$"+min;
    	}
    	
    }

    function create(domType)
    {
    	return $(document.createElement(domType));
    }

    function createText(text)
    {
    	return $(document.createTextNode(text));
    }
    
</script>
  </head>
  <body>
    
	<div id="categories" data-role="page" data-theme="a">
		<div data-role="header">
	      	<div class="ui-grid-b" style="padding:4px;">
		      	<div class="ui-block-a" align="left">
		      		<!-- <a data-icon="back" data-role="button" data-rel="back" data-theme="a">Back</a> -->
		      	</div>
		        <h2 class="ui-block-b" align="center">Gilt ReGrouper</h2>
		        <div class="ui-block-c" align="right">
		        <!-- 
		        	<form id="venueSearchForm" name="venueSearch" action="" method="post">
		        		<label for="venueSearchField" class="ui-hidden-accessible">Search</label>
		        		<input id="venueSearchField" type="search" data-inline="true" data-icon="search" placeholder="Search" />
		        	</form>
		         -->
		        </div>
	      	</div>
		</div>
		
		<div data-role="content">
			<ul id="categories_list" data-role="listview" data-filter="true" data-filter-theme="a"></ul>
		</div>
		
		<div data-role="footer" data-position="fixed">
			<h3>powered by Gilt Groupe</h3>
		</div>
	</div>
	
	
	<div id="splash" data-role="page" data-theme="a">
    	<div data-role="header">
	    	<div class="ui-grid-b" style="padding:4px;">
				<div class="ui-block-a" align="left"></div>  
				<h2 class="ui-block-b" align="center">Gilt ReGrouper</h2>
				<div class="ui-block-c" align="right"></div>
			</div>
		</div>

		<div data-role="content">
			
		</div>

		<div data-role="footer" data-position="fixed">
			<h3>powered by Gilt Groupe</h3>
		</div>
    </div>
    
    
    
    
    
    
    
    <div id="products" data-role="page" data-theme="a">
    	<div data-role="header">
	      	<div class="ui-grid-b" style="padding:4px;">
		      	<div class="ui-block-a" align="left">
					<a data-icon="back" data-role="button" data-rel="back" data-theme="a">Back</a>
				</div>
		        <h2 class="ui-block-b" align="center">Gilt ReGrouper</h2>
		        <div class="ui-block-c" align="right"></div>
	      	</div>
		</div>
		
		<div data-role="content">
			<ul id="products_list" data-role="listview"  data-filter="true" data-filter-theme="a"></ul>
		</div>
      
      <div data-role="footer" data-position="fixed">
			<h3>powered by Gilt Groupe</h3>
		</div>
    </div>
    
    
    
    
	<div id="onError" data-role="page" data-theme="a">
   	  
		<div data-role="header">
			<a href="#splash" data-icon="back" data-rel="back">Back</a>
      		<h1>Oops...</h1>
		</div>
		<div data-role="content">
			<p>Please try again later.</p>
		</div>
		
		<div data-role="footer" data-position="fixed">
			<h3>powered by Gilt Groupe</h3>
		</div>
    </div>
    
        
   
</body>
</html>
